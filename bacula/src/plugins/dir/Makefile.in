#
# Simple Makefile for building test FD plugins for Bacula
#
# Copyright (C) 2000-2020 Kern Sibbald
# License: BSD 2-Clause; see file LICENSE-FOSS
#
@MCOMMON@


# No optimization for now for easy debugging

DIRDIR=../../dird
SRCDIR=../..
LIBDIR=../../lib

topdir = @BUILD_DIR@
thisdir = src/plugins/dir
DIRPLUG_INSTALL_TARGET = @DIRPLUG_INSTALL_TARGET@
CURL_INC = @CURL_INC@
CURL_LIBS = @CURL_LIBS@

.SUFFIXES:    .c .o .lo

.c.lo:
	$(LIBTOOL_COMPILE) $(CXX) $(DEFS) $(DEBUG) $(CPPFLAGS) -I${SRCDIR} -I${DIRDIR} -DTEST_PROGRAM -c $<

all: dirpluglib.lo

install-totp:
	$(MAKE) -C totp/ install

example-plugin-dir.lo: example-plugin-dir.c ${DIRDIR}/dir_plugins.h
	$(LIBTOOL_COMPILE) $(CXX) $(DEFS) $(DEBUG) $(CFLAGS) -I../.. -I${DIRDIR} -c example-plugin-dir.c

example-plugin-dir.la: Makefile example-plugin-dir.lo
	$(LIBTOOL_LINK) $(CXX) $(LDFLAGS) -shared example-plugin-dir.lo -o $@ -rpath $(plugindir) -module -export-dynamic -avoid-version

test-authentication-api-dir.lo: test-authentication-api-dir.c ${DIRDIR}/dir_plugins.h
	$(LIBTOOL_COMPILE) $(CXX) $(DEFS) $(DEBUG) $(CFLAGS) -I../.. -I${DIRDIR} -c test-authentication-api-dir.c

test-authentication-api-dir.la: Makefile test-authentication-api-dir.lo dirpluglib.lo
	@echo "Linking $(@:.la=.so) ..."
	$(NO_ECHO)$(LIBTOOL_LINK) --silent $(CXX) $(LDFLAGS) -shared $^ -o $@ -rpath $(plugindir) -module -export-dynamic -avoid-version

install: all $(DIRPLUG_INSTALL_TARGET)
	$(MKDIR) $(DESTDIR)$(plugindir)

# $(LIBTOOL_INSTALL) $(INSTALL_PROGRAM) example-plugin-dir.la $(DESTDIR)$(plugindir)
# $(LIBTOOL_INSTALL) $(INSTALL_PROGRAM) test-authentication-api-dir.la $(DESTDIR)$(plugindir)
# $(RMF) $(DESTDIR)$(plugindir)/example-plugin-dir.la
# $(RMF) $(DESTDIR)$(plugindir)/test-authentication-api-dir.la

libtool-clean:
	find . -name '*.lo' -print | xargs $(LIBTOOL_CLEAN) $(RMF)
	$(RMF) *.la
	$(RMF) -r .libs _libs

clean: @LIBTOOL_CLEAN_TARGET@
	rm -f main *.so *.o 1 2 3

distclean: clean
	rm -f Makefile

libtool-uninstall:
	$(LIBTOOL_UNINSTALL) $(RMF) $(DESTDIR)$(plugindir)/example-plugin-dir.la

Makefile: Makefile.in $(topdir)/config.status
	cd $(topdir) \
	  && CONFIG_FILES=$(thisdir)/$@ CONFIG_HEADERS= $(SHELL) ./config.status

uninstall: @LIBTOOL_UNINSTALL_TARGET@

depend:
